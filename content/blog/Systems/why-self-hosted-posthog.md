---
title: "为什么自建 PostHog？一个独立开发者的选型思路"
date: "2026-02-17"
tags: [posthog, analytics, self-hosted]
draft: false
summary: "个人网站需要数据观测吗？Google Analytics、Umami、Plausible、PostHog 怎么选？为什么我最终选择在家里的 Mac mini 上自建 PostHog？这篇文章聊聊寒假里折腾这件事的思考过程。"
authors: ["default"]
---

> 寒假里，窗外下着雪，我对着自己的个人网站想——到底有没有人在看这些文章？看了什么？从哪来的？几天后，我搭起了一套完整的数据观测系统。这个系列，记录整个过程。

## 一、个人网站为什么需要数据观测？

先说一个真实的故事。

个人网站上线一段时间了，我花了些时间做了一次大重构——Next.js 升到最新版、TailwindCSS 4.0 全面换肤、加了 Framer Motion 做页面过渡动画，甚至还折腾了暗色模式的渐变配色。新的布局更炫酷，动画更丝滑，我自己非常满意。

然后呢？没有然后。

因为我根本不知道有没有人看到了这个首页，更不知道他们看完之后有没有继续往下点。说白了，**我在凭感觉做产品决策**。

这种感觉有点像往湖里扔石子——手一松，石子就沉了，连水花都看不见。

这就是数据观测要解决的问题——把"我觉得"变成"数据说"。

具体来讲，一套好的观测系统能回答这些问题：

- 每天有多少人访问？从哪个渠道来的？
- 哪篇文章最受欢迎？用户平均读多久？
- 首页的 CTA 按钮有多少人点击？
- 用户用什么设备和浏览器？暗色还是亮色主题？
- 发了一篇新文章之后，流量有没有变化？

这些不是什么高深的运营分析，但对一个想认真做内容的独立开发者来说，**每一个数据点都是改进的方向**。


## 二、市面方案对比：GA、Umami、Plausible、PostHog

寒假第一天，我列了个清单，认真对比了四个主流方案。

### Google Analytics（GA4）

最"正统"的选择。免费、功能强大、生态完善。

但问题也很明显：

- 数据全在 Google 手里，隐私合规是个隐患
- GA4 的学习曲线陡峭，界面对开发者不太友好
- 被越来越多的 AdBlocker 拦截，数据准确性存疑
- 本质上是「页面维度」的分析，不太适合现代 SPA 应用

### Umami

轻量级、开源、可自建。隐私友好，界面简洁。

优点是上手快、资源占用少。但功能也确实简单——只有基础的 PV/UV、来源分析和页面排行。想做更精细的用户行为分析？做不了。

**适合：只需要基础统计的静态博客。**

### Plausible

和 Umami 定位类似，也是轻量级的 GA 替代品。界面更好看，支持自建。

但同样的问题：功能天花板低。没有事件追踪的灵活性，没有 Session Replay，没有 A/B Testing。

**适合：重视隐私、只需要看大盘数据的场景。**

### PostHog

这才是让我眼前一亮的方案。

PostHog 不只是一个 Analytics 工具，它是一个**产品分析平台**，功能覆盖面非常广：

| 功能模块 | 说明 |
|---------|------|
| Product Analytics | 事件分析、漏斗、留存、用户路径 |
| Session Replay | 录屏回放，看用户真实操作 |
| Feature Flags | 特性开关，渐进式发布 |
| A/B Testing | 实验平台，数据驱动优化 |
| Surveys | 用户调研，直接在页面内弹问卷 |

关键是：**完全开源**，可以自建部署，数据 100% 在自己手里。


## 三、为什么选 PostHog？

一张表总结下对比：

| 维度 | GA4 | Umami | Plausible | PostHog |
|------|-----|-------|-----------|---------| 
| 开源 | ❌ | ✅ | ✅ | ✅ |
| 可自建 | ❌ | ✅ | ✅ | ✅ |
| 数据归属 | Google | 自己 | 自己 | 自己 |
| 事件追踪 | ✅ | 基础 | 基础 | ✅ 灵活 |
| Session Replay | ❌ | ❌ | ❌ | ✅ |
| A/B Testing | 需额外工具 | ❌ | ❌ | ✅ |
| Feature Flags | ❌ | ❌ | ❌ | ✅ |
| 学习曲线 | 陡峭 | 低 | 低 | 中等 |

PostHog 的优势很明显：**功能全景覆盖，而且开源可自建**。

对我来说最吸引人的三点是：

1. **事件驱动模型**：不像 GA 那样围绕"页面"组织数据，PostHog 的核心概念是"事件"。用户点了什么、看了什么、停留多久，都是独立的事件流。对 SPA 应用来说这才是正确的数据模型。

2. **Session Replay**：能直接回放用户的操作过程。当你在纠结"这个交互设计到底好不好用"的时候，看十个真实用户的操作录像，比猜一百次都管用。

3. **A/B Testing 内置**：不需要再接第三方实验平台。之前做过一段时间的实验相关工作，我对这个功能有天然的好感——数据驱动优化，这四个字说起来容易，能在自己的项目上实践一把，才算真正落地。

## 四、为什么自建而不用 PostHog Cloud？

PostHog 提供了云服务版本，免费额度是每月 100 万事件。对小网站来说其实够用了。

那为什么还要自建？三个原因：

**第一，数据完全掌控。**

云版本的数据存在 PostHog 的服务器上。虽然他们的隐私政策还算靠谱，但对于一个有「折腾精神」的开发者来说，数据在自己的机器上才睡得踏实。

**第二，没有任何限制。**

Cloud 版免费额度用完就得付费，而且高级功能（比如 Group Analytics）需要付费计划。自建版本没有这些限制——所有功能都可以用，事件量也不受限。

**第三，学习基础设施能力。**

这其实是最重要的原因。自建 PostHog 涉及到 Docker 编排、数据库管理（ClickHouse + PostgreSQL）、内网穿透、反向代理、TLS 证书……这一整套搞下来，对系统运维能力的提升是实打实的。

说白了，**自建 PostHog 本身就是一个很好的学习项目**。寒假嘛，不就是拿来折腾的。

## 五、PostHog 技术架构全貌

在正式动手之前，先花点时间了解 PostHog 的技术架构。这有助于理解后面部署和排障的逻辑。

### 核心组件

PostHog 不是一个单体应用，而是一个微服务架构的系统。核心组件包括：

- **ClickHouse**：列式分析数据库，负责存储和查询所有事件数据。这是 PostHog 的性能核心——亿级事件的查询也能秒级返回。
- **PostgreSQL**：存储元数据，比如项目配置、用户信息、Dashboard 定义等。
- **Redis**：缓存层 + 消息队列。
- **Kafka**：事件流的消息总线，JS SDK 发来的事件先进 Kafka，再写入 ClickHouse。
- **Temporal**：工作流引擎，负责编排异步任务。

### 服务拓扑

在 Docker 部署中，PostHog 会启动十几个服务，每个各司其职：

| 服务 | 职责 |
|------|------|
| `web` | Django Web 应用，提供 UI 和 API |
| `worker` | Celery Worker，处理异步任务 |
| `plugins` | Node.js 插件引擎，处理事件摄入 |
| `capture` | 事件捕获服务，接收 SDK 发送的数据 |
| `feature-flags` | 特性标记评估服务 |
| `temporal` | 工作流引擎 |
| `proxy` | Caddy 反向代理，统一入口 |

看起来很复杂？别担心，实际部署的时候一个 `docker compose up` 就全起来了。

![PostHog 数据流架构图](/images/blog/why-self-hosted-posthog/data-flow-architecture.png)

### 数据流

从用户访问网站到数据出现在 Dashboard，整个数据流是这样的：

```
浏览器 JS SDK → capture 服务 → Kafka → ClickHouse
                                         ↓
                              web 服务 ← 查询 → Dashboard
```

简单粗暴理解就是：**SDK 发事件 → Kafka 排队 → ClickHouse 存储 → Dashboard 查询展示**。

### 与 Google Analytics 的架构差异

GA 是传统的「页面浏览」模型——核心维度是 Page，围绕页面做 PV、UV、跳出率等统计。

PostHog 是「事件驱动」模型——一切皆事件（Event）。页面浏览是事件，按钮点击是事件，表单提交也是事件。每个事件都可以带任意的自定义属性（Properties）。

这种模型更灵活，也更适合现代 Web 应用。比如在 SPA（单页应用）中，用户可能在一个页面里做了很多操作，但传统 GA 只会记录一次 pageview。PostHog 能把这些操作全部捕获。

## 六、我的整体架构

最后，快速预览一下我的部署架构，也就是这个系列后面几篇要详细展开的内容：

```
┌──────────────────────────────────────────────────────────────┐
│                         用户浏览器                           │
│                    (posthog-js SDK)                          │
└────────────────────────┬─────────────────────────────────────┘
                         │ HTTPS 事件上报
                         ▼
┌──────────────────────────────────────────────────────────────┐
│              腾讯云 (公网入口)                                │
│   nginx 反代 + Let's Encrypt TLS                            │
│   https://ph.yourdomain.com                                 │
└────────────────────────┬─────────────────────────────────────┘
                         │ FRP 隧道
                         ▼
┌──────────────────────────────────────────────────────────────┐
│              Mac mini (家庭内网)                              │
│   Docker Compose 运行 PostHog 全套服务                       │
│   ClickHouse · PostgreSQL · Redis · Kafka · Web · Worker    │
└──────────────────────────────────────────────────────────────┘
```

整个链路就是：**网站 SDK → 腾讯云反代 → FRP 隧道 → Mac mini 上的 PostHog**。

为什么是这个架构？

- **Mac mini** 放在家里，低功耗长期运行，省了云服务器费用
- **FRP 内网穿透**，解决家庭网络没有公网 IP 的问题
- **腾讯云 nginx**，提供域名 + HTTPS（浏览器必须 HTTPS 才能向 HTTPS 页面发请求）
- **PostHog 全套 Docker**，一键部署，开箱即用

![自建 PostHog 部署架构总览](/images/blog/why-self-hosted-posthog/deployment-architecture.png)

## 写在最后

这个寒假，我花了几天时间，在家里的 Mac mini 上搭起了一套完整的 PostHog 观测系统。

回头看，选择自建 PostHog，本质上是在**功能完整性**和**部署复杂度**之间做了一个取舍。如果你只需要看看 PV 和来源分布，Umami 或 Plausible 就够了，半小时搞定。

但如果你和我一样，想要：
- 精细的事件追踪
- 用户操作回放
- A/B 测试能力
- 数据完全自主可控
- 顺便练练基础设施技能

那 PostHog 自建是一个非常值得投入的方案。

折腾了一圈下来，最大的感受是：当你终于能看见自己网站上真实的用户行为时，那种"原来如此"的感觉，比任何技术文档都让人兴奋。

下一篇，我会详细讲**从零在 Mac mini 上部署 PostHog 的全过程**——包括 Docker 配置、内网穿透、HTTPS 证书，以及一路上踩过的坑。

敬请期待 🚀
