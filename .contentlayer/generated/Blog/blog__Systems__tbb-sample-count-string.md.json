{
  "title": "TBB Sample 01",
  "date": "2022-11-29T00:00:00.000Z",
  "tags": [
    "HPC",
    "C++"
  ],
  "draft": false,
  "summary": "Count Strings",
  "authors": [
    "default"
  ],
  "body": {
    "raw": "\n## 简介\n\nThe example counts the number of unique words in a text. [code](https://github.com/oneapi-src/oneTBB/tree/master/examples/concurrent_hash_map/count_strings)\n\n\n## 细节\n\n\n### 重载hash\n\n```cpp\nnamespace std {\n\ntemplate <typename CharT, typename Traits, typename Allocator>\nclass hash<std::basic_string<CharT, Traits, Allocator>> {\npublic:\n    std::size_t operator()(const std::basic_string<CharT, Traits, Allocator>& s) const {\n        std::size_t h = 0;\n        for (const CharT* c = s.c_str(); *c; ++c) {\n            h = h * hash_multiplier ^ char_hash(*c);\n        }\n        return h;\n    }\n\nprivate:\n    static constexpr std::size_t hash_multiplier = (std::size_t)(\n        (sizeof(std::size_t) == sizeof(unsigned)) ? 2654435769U : 11400714819323198485ULL);\n\n    std::hash<CharT> char_hash;\n}; // strunt hash<std::basic_string>\n\n} // namespace std\n```\n\n注意点：\n\n1. 计算自定义类型的hash value\n  1. `std::hash<CharT> char_hash`：其提供了`CharT`类型的hash值\n  2. `std::size_t operator()`：通过重载运算符`()`，返回自定义类型的hash value\n2. class hash的定义\n   1. `class hash<std::basic_string<...>>`：模板特化为`std::basic_string`类型\n   2. `<CharT, Traits, Allocator>`：模板类型推断\n\n\n### 定义`MyString`类，\n\n```cpp\n//! String type\ntypedef std::basic_string<char, std::char_traits<char>, oneapi::tbb::tbb_allocator<char>> MyString;\n```\n\n注意点：\n\n1. `char_traits`\n  > Traits 是一个用来携带信息的很小的对象（或结构）， 在其他对象或算法中用这一信息来确定策略或实现细节。\n\n1. `tbb_allocator`：在多线程的环境下，多个线程使用相邻内存时会产生频繁的缓存切换（csapp）,通过使用`tbb_allocator`，可以避免这一问题\n   \n### 并行Hash Map\n\n```cpp\n//! A concurrent hash table that maps strings to ints.\ntypedef oneapi::tbb::concurrent_hash_map<MyString, int> StringTable;\n\n//! Function object for counting occurrences of strings.\nstruct Tally {\n    StringTable& table;\n    Tally(StringTable& table_) : table(table_) {}\n    void operator()(const oneapi::tbb::blocked_range<MyString*> range) const {\n        for (MyString* p = range.begin(); p != range.end(); ++p) {\n            StringTable::accessor a;\n            table.insert(a, *p);\n            a->second += 1;\n        }\n    }\n};\n```\n\n注意点:\n\n1. [`concurrent_hash_map`](https://oneapi-src.github.io/oneTBB/main/tbb_userguide/concurrent_hash_map.html): 一个支持并行的hash map\n\n2. `oneapi::tbb::blocked_range<...>`: \n   1. 模板参数设置**迭代（传入数据的）类型**\n   2. `tbb::parallel_for`会调用`Tally(table)`的`operator()`，`blocked_range`作为参数传入\n      ```cpp\n      StringTable table;\n      oneapi::tbb::parallel_for( \n        oneapi::tbb::blocked_range<MyString*>(Data, Data + N, 1000), \n        Tally(table));\n      ```\n\n3. [`StringTable::accessor`](https://oneapi-src.github.io/oneTBB/main/tbb_userguide/concurrent_hash_map.html):\n\n    > An accessor represents update (write) access. As long as it points to an element, all other attempts to look up that key in the table block until the accessor is done. \n\n    `a->second += 1`代表对value加1\n\n## 结语\n\n这份代码样例展示了基于tbb的并行hash的实现，包含了tbb的一些基础用法，具有一定参考价值。\n\n\n",
    "code": "var Component=(()=>{var h=Object.create;var l=Object.defineProperty;var m=Object.getOwnPropertyDescriptor;var u=Object.getOwnPropertyNames;var N=Object.getPrototypeOf,k=Object.prototype.hasOwnProperty;var b=(a,n)=>()=>(n||a((n={exports:{}}).exports,n),n.exports),g=(a,n)=>{for(var s in n)l(a,s,{get:n[s],enumerable:!0})},t=(a,n,s,o)=>{if(n&&typeof n==\"object\"||typeof n==\"function\")for(let c of u(n))!k.call(a,c)&&c!==s&&l(a,c,{get:()=>n[c],enumerable:!(o=m(n,c))||o.enumerable});return a};var y=(a,n,s)=>(s=a!=null?h(N(a)):{},t(n||!a||!a.__esModule?l(s,\"default\",{value:a,enumerable:!0}):s,a)),_=a=>t(l({},\"__esModule\",{value:!0}),a);var r=b((x,i)=>{i.exports=_jsx_runtime});var w={};g(w,{default:()=>p,frontmatter:()=>f});var e=y(r()),f={title:\"TBB Sample 01\",date:\"2022-11-29\",tags:[\"HPC\",\"C++\"],draft:!1,summary:\"Count Strings\",authors:[\"default\"]};function d(a){let n={a:\"a\",blockquote:\"blockquote\",code:\"code\",h2:\"h2\",h3:\"h3\",li:\"li\",ol:\"ol\",p:\"p\",pre:\"pre\",span:\"span\",strong:\"strong\",...a.components};return(0,e.jsxs)(e.Fragment,{children:[(0,e.jsxs)(n.h2,{id:\"\\u7B80\\u4ECB\",className:\"content-header\",children:[(0,e.jsx)(n.a,{\"aria-hidden\":\"true\",tabIndex:\"-1\",href:\"#\\u7B80\\u4ECB\",children:(0,e.jsx)(n.span,{className:\"icon icon-link\"})}),\"\\u7B80\\u4ECB\"]}),`\n`,(0,e.jsxs)(n.p,{children:[\"The example counts the number of unique words in a text. \",(0,e.jsx)(n.a,{href:\"https://github.com/oneapi-src/oneTBB/tree/master/examples/concurrent_hash_map/count_strings\",children:\"code\"})]}),`\n`,(0,e.jsxs)(n.h2,{id:\"\\u7EC6\\u8282\",className:\"content-header\",children:[(0,e.jsx)(n.a,{\"aria-hidden\":\"true\",tabIndex:\"-1\",href:\"#\\u7EC6\\u8282\",children:(0,e.jsx)(n.span,{className:\"icon icon-link\"})}),\"\\u7EC6\\u8282\"]}),`\n`,(0,e.jsxs)(n.h3,{id:\"\\u91CD\\u8F7Dhash\",className:\"content-header\",children:[(0,e.jsx)(n.a,{\"aria-hidden\":\"true\",tabIndex:\"-1\",href:\"#\\u91CD\\u8F7Dhash\",children:(0,e.jsx)(n.span,{className:\"icon icon-link\"})}),\"\\u91CD\\u8F7Dhash\"]}),`\n`,(0,e.jsx)(n.pre,{className:\"language-cpp\",children:(0,e.jsxs)(n.code,{className:\"language-cpp code-highlight\",children:[(0,e.jsxs)(n.span,{className:\"code-line\",children:[(0,e.jsx)(n.span,{className:\"token keyword\",children:\"namespace\"}),\" std \",(0,e.jsx)(n.span,{className:\"token punctuation\",children:\"{\"}),`\n`]}),(0,e.jsx)(n.span,{className:\"code-line\",children:`\n`}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[(0,e.jsx)(n.span,{className:\"token keyword\",children:\"template\"}),\" \",(0,e.jsx)(n.span,{className:\"token operator\",children:\"<\"}),(0,e.jsx)(n.span,{className:\"token keyword\",children:\"typename\"}),\" \",(0,e.jsx)(n.span,{className:\"token class-name\",children:\"CharT\"}),(0,e.jsx)(n.span,{className:\"token punctuation\",children:\",\"}),\" \",(0,e.jsx)(n.span,{className:\"token keyword\",children:\"typename\"}),\" \",(0,e.jsx)(n.span,{className:\"token class-name\",children:\"Traits\"}),(0,e.jsx)(n.span,{className:\"token punctuation\",children:\",\"}),\" \",(0,e.jsx)(n.span,{className:\"token keyword\",children:\"typename\"}),\" \",(0,e.jsx)(n.span,{className:\"token class-name\",children:\"Allocator\"}),(0,e.jsx)(n.span,{className:\"token operator\",children:\">\"}),`\n`]}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[(0,e.jsx)(n.span,{className:\"token keyword\",children:\"class\"}),\" \",(0,e.jsx)(n.span,{className:\"token class-name\",children:\"hash\"}),(0,e.jsx)(n.span,{className:\"token operator\",children:\"<\"}),\"std\",(0,e.jsx)(n.span,{className:\"token double-colon punctuation\",children:\"::\"}),\"basic_string\",(0,e.jsx)(n.span,{className:\"token operator\",children:\"<\"}),\"CharT\",(0,e.jsx)(n.span,{className:\"token punctuation\",children:\",\"}),\" Traits\",(0,e.jsx)(n.span,{className:\"token punctuation\",children:\",\"}),\" Allocator\",(0,e.jsx)(n.span,{className:\"token operator\",children:\">>\"}),\" \",(0,e.jsx)(n.span,{className:\"token punctuation\",children:\"{\"}),`\n`]}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[(0,e.jsx)(n.span,{className:\"token keyword\",children:\"public\"}),(0,e.jsx)(n.span,{className:\"token operator\",children:\":\"}),`\n`]}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[\"    std\",(0,e.jsx)(n.span,{className:\"token double-colon punctuation\",children:\"::\"}),\"size_t \",(0,e.jsx)(n.span,{className:\"token keyword\",children:\"operator\"}),(0,e.jsx)(n.span,{className:\"token punctuation\",children:\"(\"}),(0,e.jsx)(n.span,{className:\"token punctuation\",children:\")\"}),(0,e.jsx)(n.span,{className:\"token punctuation\",children:\"(\"}),(0,e.jsx)(n.span,{className:\"token keyword\",children:\"const\"}),\" std\",(0,e.jsx)(n.span,{className:\"token double-colon punctuation\",children:\"::\"}),\"basic_string\",(0,e.jsx)(n.span,{className:\"token operator\",children:\"<\"}),\"CharT\",(0,e.jsx)(n.span,{className:\"token punctuation\",children:\",\"}),\" Traits\",(0,e.jsx)(n.span,{className:\"token punctuation\",children:\",\"}),\" Allocator\",(0,e.jsx)(n.span,{className:\"token operator\",children:\">\"}),(0,e.jsx)(n.span,{className:\"token operator\",children:\"&\"}),\" s\",(0,e.jsx)(n.span,{className:\"token punctuation\",children:\")\"}),\" \",(0,e.jsx)(n.span,{className:\"token keyword\",children:\"const\"}),\" \",(0,e.jsx)(n.span,{className:\"token punctuation\",children:\"{\"}),`\n`]}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[\"        std\",(0,e.jsx)(n.span,{className:\"token double-colon punctuation\",children:\"::\"}),\"size_t h \",(0,e.jsx)(n.span,{className:\"token operator\",children:\"=\"}),\" \",(0,e.jsx)(n.span,{className:\"token number\",children:\"0\"}),(0,e.jsx)(n.span,{className:\"token punctuation\",children:\";\"}),`\n`]}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[\"        \",(0,e.jsx)(n.span,{className:\"token keyword\",children:\"for\"}),\" \",(0,e.jsx)(n.span,{className:\"token punctuation\",children:\"(\"}),(0,e.jsx)(n.span,{className:\"token keyword\",children:\"const\"}),\" CharT\",(0,e.jsx)(n.span,{className:\"token operator\",children:\"*\"}),\" c \",(0,e.jsx)(n.span,{className:\"token operator\",children:\"=\"}),\" s\",(0,e.jsx)(n.span,{className:\"token punctuation\",children:\".\"}),(0,e.jsx)(n.span,{className:\"token function\",children:\"c_str\"}),(0,e.jsx)(n.span,{className:\"token punctuation\",children:\"(\"}),(0,e.jsx)(n.span,{className:\"token punctuation\",children:\")\"}),(0,e.jsx)(n.span,{className:\"token punctuation\",children:\";\"}),\" \",(0,e.jsx)(n.span,{className:\"token operator\",children:\"*\"}),\"c\",(0,e.jsx)(n.span,{className:\"token punctuation\",children:\";\"}),\" \",(0,e.jsx)(n.span,{className:\"token operator\",children:\"++\"}),\"c\",(0,e.jsx)(n.span,{className:\"token punctuation\",children:\")\"}),\" \",(0,e.jsx)(n.span,{className:\"token punctuation\",children:\"{\"}),`\n`]}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[\"            h \",(0,e.jsx)(n.span,{className:\"token operator\",children:\"=\"}),\" h \",(0,e.jsx)(n.span,{className:\"token operator\",children:\"*\"}),\" hash_multiplier \",(0,e.jsx)(n.span,{className:\"token operator\",children:\"^\"}),\" \",(0,e.jsx)(n.span,{className:\"token function\",children:\"char_hash\"}),(0,e.jsx)(n.span,{className:\"token punctuation\",children:\"(\"}),(0,e.jsx)(n.span,{className:\"token operator\",children:\"*\"}),\"c\",(0,e.jsx)(n.span,{className:\"token punctuation\",children:\")\"}),(0,e.jsx)(n.span,{className:\"token punctuation\",children:\";\"}),`\n`]}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[\"        \",(0,e.jsx)(n.span,{className:\"token punctuation\",children:\"}\"}),`\n`]}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[\"        \",(0,e.jsx)(n.span,{className:\"token keyword\",children:\"return\"}),\" h\",(0,e.jsx)(n.span,{className:\"token punctuation\",children:\";\"}),`\n`]}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[\"    \",(0,e.jsx)(n.span,{className:\"token punctuation\",children:\"}\"}),`\n`]}),(0,e.jsx)(n.span,{className:\"code-line\",children:`\n`}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[(0,e.jsx)(n.span,{className:\"token keyword\",children:\"private\"}),(0,e.jsx)(n.span,{className:\"token operator\",children:\":\"}),`\n`]}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[\"    \",(0,e.jsx)(n.span,{className:\"token keyword\",children:\"static\"}),\" \",(0,e.jsx)(n.span,{className:\"token keyword\",children:\"constexpr\"}),\" std\",(0,e.jsx)(n.span,{className:\"token double-colon punctuation\",children:\"::\"}),\"size_t hash_multiplier \",(0,e.jsx)(n.span,{className:\"token operator\",children:\"=\"}),\" \",(0,e.jsx)(n.span,{className:\"token punctuation\",children:\"(\"}),\"std\",(0,e.jsx)(n.span,{className:\"token double-colon punctuation\",children:\"::\"}),\"size_t\",(0,e.jsx)(n.span,{className:\"token punctuation\",children:\")\"}),(0,e.jsx)(n.span,{className:\"token punctuation\",children:\"(\"}),`\n`]}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[\"        \",(0,e.jsx)(n.span,{className:\"token punctuation\",children:\"(\"}),(0,e.jsx)(n.span,{className:\"token keyword\",children:\"sizeof\"}),(0,e.jsx)(n.span,{className:\"token punctuation\",children:\"(\"}),\"std\",(0,e.jsx)(n.span,{className:\"token double-colon punctuation\",children:\"::\"}),\"size_t\",(0,e.jsx)(n.span,{className:\"token punctuation\",children:\")\"}),\" \",(0,e.jsx)(n.span,{className:\"token operator\",children:\"==\"}),\" \",(0,e.jsx)(n.span,{className:\"token keyword\",children:\"sizeof\"}),(0,e.jsx)(n.span,{className:\"token punctuation\",children:\"(\"}),(0,e.jsx)(n.span,{className:\"token keyword\",children:\"unsigned\"}),(0,e.jsx)(n.span,{className:\"token punctuation\",children:\")\"}),(0,e.jsx)(n.span,{className:\"token punctuation\",children:\")\"}),\" \",(0,e.jsx)(n.span,{className:\"token operator\",children:\"?\"}),\" \",(0,e.jsx)(n.span,{className:\"token number\",children:\"2654435769U\"}),\" \",(0,e.jsx)(n.span,{className:\"token operator\",children:\":\"}),\" \",(0,e.jsx)(n.span,{className:\"token number\",children:\"11400714819323198485ULL\"}),(0,e.jsx)(n.span,{className:\"token punctuation\",children:\")\"}),(0,e.jsx)(n.span,{className:\"token punctuation\",children:\";\"}),`\n`]}),(0,e.jsx)(n.span,{className:\"code-line\",children:`\n`}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[\"    std\",(0,e.jsx)(n.span,{className:\"token double-colon punctuation\",children:\"::\"}),\"hash\",(0,e.jsx)(n.span,{className:\"token operator\",children:\"<\"}),\"CharT\",(0,e.jsx)(n.span,{className:\"token operator\",children:\">\"}),\" char_hash\",(0,e.jsx)(n.span,{className:\"token punctuation\",children:\";\"}),`\n`]}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[(0,e.jsx)(n.span,{className:\"token punctuation\",children:\"}\"}),(0,e.jsx)(n.span,{className:\"token punctuation\",children:\";\"}),\" \",(0,e.jsx)(n.span,{className:\"token comment\",children:\"// strunt hash<std::basic_string>\"}),`\n`]}),(0,e.jsx)(n.span,{className:\"code-line\",children:`\n`}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[(0,e.jsx)(n.span,{className:\"token punctuation\",children:\"}\"}),\" \",(0,e.jsx)(n.span,{className:\"token comment\",children:\"// namespace std\"}),`\n`]})]})}),`\n`,(0,e.jsx)(n.p,{children:\"\\u6CE8\\u610F\\u70B9\\uFF1A\"}),`\n`,(0,e.jsxs)(n.ol,{children:[`\n`,(0,e.jsx)(n.li,{children:\"\\u8BA1\\u7B97\\u81EA\\u5B9A\\u4E49\\u7C7B\\u578B\\u7684hash value\"}),`\n`,(0,e.jsxs)(n.li,{children:[(0,e.jsx)(n.code,{children:\"std::hash<CharT> char_hash\"}),\"\\uFF1A\\u5176\\u63D0\\u4F9B\\u4E86\",(0,e.jsx)(n.code,{children:\"CharT\"}),\"\\u7C7B\\u578B\\u7684hash\\u503C\"]}),`\n`,(0,e.jsxs)(n.li,{children:[(0,e.jsx)(n.code,{children:\"std::size_t operator()\"}),\"\\uFF1A\\u901A\\u8FC7\\u91CD\\u8F7D\\u8FD0\\u7B97\\u7B26\",(0,e.jsx)(n.code,{children:\"()\"}),\"\\uFF0C\\u8FD4\\u56DE\\u81EA\\u5B9A\\u4E49\\u7C7B\\u578B\\u7684hash value\"]}),`\n`,(0,e.jsxs)(n.li,{children:[\"class hash\\u7684\\u5B9A\\u4E49\",`\n`,(0,e.jsxs)(n.ol,{children:[`\n`,(0,e.jsxs)(n.li,{children:[(0,e.jsx)(n.code,{children:\"class hash<std::basic_string<...>>\"}),\"\\uFF1A\\u6A21\\u677F\\u7279\\u5316\\u4E3A\",(0,e.jsx)(n.code,{children:\"std::basic_string\"}),\"\\u7C7B\\u578B\"]}),`\n`,(0,e.jsxs)(n.li,{children:[(0,e.jsx)(n.code,{children:\"<CharT, Traits, Allocator>\"}),\"\\uFF1A\\u6A21\\u677F\\u7C7B\\u578B\\u63A8\\u65AD\"]}),`\n`]}),`\n`]}),`\n`]}),`\n`,(0,e.jsxs)(n.h3,{id:\"\\u5B9A\\u4E49mystring\\u7C7B\",className:\"content-header\",children:[(0,e.jsx)(n.a,{\"aria-hidden\":\"true\",tabIndex:\"-1\",href:\"#\\u5B9A\\u4E49mystring\\u7C7B\",children:(0,e.jsx)(n.span,{className:\"icon icon-link\"})}),\"\\u5B9A\\u4E49\",(0,e.jsx)(n.code,{children:\"MyString\"}),\"\\u7C7B\\uFF0C\"]}),`\n`,(0,e.jsx)(n.pre,{className:\"language-cpp\",children:(0,e.jsxs)(n.code,{className:\"language-cpp code-highlight\",children:[(0,e.jsxs)(n.span,{className:\"code-line\",children:[(0,e.jsx)(n.span,{className:\"token comment\",children:\"//! String type\"}),`\n`]}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[(0,e.jsx)(n.span,{className:\"token keyword\",children:\"typedef\"}),\" std\",(0,e.jsx)(n.span,{className:\"token double-colon punctuation\",children:\"::\"}),\"basic_string\",(0,e.jsx)(n.span,{className:\"token operator\",children:\"<\"}),(0,e.jsx)(n.span,{className:\"token keyword\",children:\"char\"}),(0,e.jsx)(n.span,{className:\"token punctuation\",children:\",\"}),\" std\",(0,e.jsx)(n.span,{className:\"token double-colon punctuation\",children:\"::\"}),\"char_traits\",(0,e.jsx)(n.span,{className:\"token operator\",children:\"<\"}),(0,e.jsx)(n.span,{className:\"token keyword\",children:\"char\"}),(0,e.jsx)(n.span,{className:\"token operator\",children:\">\"}),(0,e.jsx)(n.span,{className:\"token punctuation\",children:\",\"}),\" oneapi\",(0,e.jsx)(n.span,{className:\"token double-colon punctuation\",children:\"::\"}),\"tbb\",(0,e.jsx)(n.span,{className:\"token double-colon punctuation\",children:\"::\"}),\"tbb_allocator\",(0,e.jsx)(n.span,{className:\"token operator\",children:\"<\"}),(0,e.jsx)(n.span,{className:\"token keyword\",children:\"char\"}),(0,e.jsx)(n.span,{className:\"token operator\",children:\">>\"}),\" MyString\",(0,e.jsx)(n.span,{className:\"token punctuation\",children:\";\"}),`\n`]})]})}),`\n`,(0,e.jsx)(n.p,{children:\"\\u6CE8\\u610F\\u70B9\\uFF1A\"}),`\n`,(0,e.jsxs)(n.ol,{children:[`\n`,(0,e.jsx)(n.li,{children:(0,e.jsx)(n.code,{children:\"char_traits\"})}),`\n`]}),`\n`,(0,e.jsxs)(n.blockquote,{children:[`\n`,(0,e.jsx)(n.p,{children:\"Traits \\u662F\\u4E00\\u4E2A\\u7528\\u6765\\u643A\\u5E26\\u4FE1\\u606F\\u7684\\u5F88\\u5C0F\\u7684\\u5BF9\\u8C61\\uFF08\\u6216\\u7ED3\\u6784\\uFF09\\uFF0C \\u5728\\u5176\\u4ED6\\u5BF9\\u8C61\\u6216\\u7B97\\u6CD5\\u4E2D\\u7528\\u8FD9\\u4E00\\u4FE1\\u606F\\u6765\\u786E\\u5B9A\\u7B56\\u7565\\u6216\\u5B9E\\u73B0\\u7EC6\\u8282\\u3002\"}),`\n`]}),`\n`,(0,e.jsxs)(n.ol,{children:[`\n`,(0,e.jsxs)(n.li,{children:[(0,e.jsx)(n.code,{children:\"tbb_allocator\"}),\"\\uFF1A\\u5728\\u591A\\u7EBF\\u7A0B\\u7684\\u73AF\\u5883\\u4E0B\\uFF0C\\u591A\\u4E2A\\u7EBF\\u7A0B\\u4F7F\\u7528\\u76F8\\u90BB\\u5185\\u5B58\\u65F6\\u4F1A\\u4EA7\\u751F\\u9891\\u7E41\\u7684\\u7F13\\u5B58\\u5207\\u6362\\uFF08csapp\\uFF09,\\u901A\\u8FC7\\u4F7F\\u7528\",(0,e.jsx)(n.code,{children:\"tbb_allocator\"}),\"\\uFF0C\\u53EF\\u4EE5\\u907F\\u514D\\u8FD9\\u4E00\\u95EE\\u9898\"]}),`\n`]}),`\n`,(0,e.jsxs)(n.h3,{id:\"\\u5E76\\u884Chash-map\",className:\"content-header\",children:[(0,e.jsx)(n.a,{\"aria-hidden\":\"true\",tabIndex:\"-1\",href:\"#\\u5E76\\u884Chash-map\",children:(0,e.jsx)(n.span,{className:\"icon icon-link\"})}),\"\\u5E76\\u884CHash Map\"]}),`\n`,(0,e.jsx)(n.pre,{className:\"language-cpp\",children:(0,e.jsxs)(n.code,{className:\"language-cpp code-highlight\",children:[(0,e.jsxs)(n.span,{className:\"code-line\",children:[(0,e.jsx)(n.span,{className:\"token comment\",children:\"//! A concurrent hash table that maps strings to ints.\"}),`\n`]}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[(0,e.jsx)(n.span,{className:\"token keyword\",children:\"typedef\"}),\" oneapi\",(0,e.jsx)(n.span,{className:\"token double-colon punctuation\",children:\"::\"}),\"tbb\",(0,e.jsx)(n.span,{className:\"token double-colon punctuation\",children:\"::\"}),\"concurrent_hash_map\",(0,e.jsx)(n.span,{className:\"token operator\",children:\"<\"}),\"MyString\",(0,e.jsx)(n.span,{className:\"token punctuation\",children:\",\"}),\" \",(0,e.jsx)(n.span,{className:\"token keyword\",children:\"int\"}),(0,e.jsx)(n.span,{className:\"token operator\",children:\">\"}),\" StringTable\",(0,e.jsx)(n.span,{className:\"token punctuation\",children:\";\"}),`\n`]}),(0,e.jsx)(n.span,{className:\"code-line\",children:`\n`}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[(0,e.jsx)(n.span,{className:\"token comment\",children:\"//! Function object for counting occurrences of strings.\"}),`\n`]}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[(0,e.jsx)(n.span,{className:\"token keyword\",children:\"struct\"}),\" \",(0,e.jsx)(n.span,{className:\"token class-name\",children:\"Tally\"}),\" \",(0,e.jsx)(n.span,{className:\"token punctuation\",children:\"{\"}),`\n`]}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[\"    StringTable\",(0,e.jsx)(n.span,{className:\"token operator\",children:\"&\"}),\" table\",(0,e.jsx)(n.span,{className:\"token punctuation\",children:\";\"}),`\n`]}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[\"    \",(0,e.jsx)(n.span,{className:\"token function\",children:\"Tally\"}),(0,e.jsx)(n.span,{className:\"token punctuation\",children:\"(\"}),\"StringTable\",(0,e.jsx)(n.span,{className:\"token operator\",children:\"&\"}),\" table_\",(0,e.jsx)(n.span,{className:\"token punctuation\",children:\")\"}),\" \",(0,e.jsx)(n.span,{className:\"token operator\",children:\":\"}),\" \",(0,e.jsx)(n.span,{className:\"token function\",children:\"table\"}),(0,e.jsx)(n.span,{className:\"token punctuation\",children:\"(\"}),\"table_\",(0,e.jsx)(n.span,{className:\"token punctuation\",children:\")\"}),\" \",(0,e.jsx)(n.span,{className:\"token punctuation\",children:\"{\"}),(0,e.jsx)(n.span,{className:\"token punctuation\",children:\"}\"}),`\n`]}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[\"    \",(0,e.jsx)(n.span,{className:\"token keyword\",children:\"void\"}),\" \",(0,e.jsx)(n.span,{className:\"token keyword\",children:\"operator\"}),(0,e.jsx)(n.span,{className:\"token punctuation\",children:\"(\"}),(0,e.jsx)(n.span,{className:\"token punctuation\",children:\")\"}),(0,e.jsx)(n.span,{className:\"token punctuation\",children:\"(\"}),(0,e.jsx)(n.span,{className:\"token keyword\",children:\"const\"}),\" oneapi\",(0,e.jsx)(n.span,{className:\"token double-colon punctuation\",children:\"::\"}),\"tbb\",(0,e.jsx)(n.span,{className:\"token double-colon punctuation\",children:\"::\"}),\"blocked_range\",(0,e.jsx)(n.span,{className:\"token operator\",children:\"<\"}),\"MyString\",(0,e.jsx)(n.span,{className:\"token operator\",children:\"*\"}),(0,e.jsx)(n.span,{className:\"token operator\",children:\">\"}),\" range\",(0,e.jsx)(n.span,{className:\"token punctuation\",children:\")\"}),\" \",(0,e.jsx)(n.span,{className:\"token keyword\",children:\"const\"}),\" \",(0,e.jsx)(n.span,{className:\"token punctuation\",children:\"{\"}),`\n`]}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[\"        \",(0,e.jsx)(n.span,{className:\"token keyword\",children:\"for\"}),\" \",(0,e.jsx)(n.span,{className:\"token punctuation\",children:\"(\"}),\"MyString\",(0,e.jsx)(n.span,{className:\"token operator\",children:\"*\"}),\" p \",(0,e.jsx)(n.span,{className:\"token operator\",children:\"=\"}),\" range\",(0,e.jsx)(n.span,{className:\"token punctuation\",children:\".\"}),(0,e.jsx)(n.span,{className:\"token function\",children:\"begin\"}),(0,e.jsx)(n.span,{className:\"token punctuation\",children:\"(\"}),(0,e.jsx)(n.span,{className:\"token punctuation\",children:\")\"}),(0,e.jsx)(n.span,{className:\"token punctuation\",children:\";\"}),\" p \",(0,e.jsx)(n.span,{className:\"token operator\",children:\"!=\"}),\" range\",(0,e.jsx)(n.span,{className:\"token punctuation\",children:\".\"}),(0,e.jsx)(n.span,{className:\"token function\",children:\"end\"}),(0,e.jsx)(n.span,{className:\"token punctuation\",children:\"(\"}),(0,e.jsx)(n.span,{className:\"token punctuation\",children:\")\"}),(0,e.jsx)(n.span,{className:\"token punctuation\",children:\";\"}),\" \",(0,e.jsx)(n.span,{className:\"token operator\",children:\"++\"}),\"p\",(0,e.jsx)(n.span,{className:\"token punctuation\",children:\")\"}),\" \",(0,e.jsx)(n.span,{className:\"token punctuation\",children:\"{\"}),`\n`]}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[\"            StringTable\",(0,e.jsx)(n.span,{className:\"token double-colon punctuation\",children:\"::\"}),\"accessor a\",(0,e.jsx)(n.span,{className:\"token punctuation\",children:\";\"}),`\n`]}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[\"            table\",(0,e.jsx)(n.span,{className:\"token punctuation\",children:\".\"}),(0,e.jsx)(n.span,{className:\"token function\",children:\"insert\"}),(0,e.jsx)(n.span,{className:\"token punctuation\",children:\"(\"}),\"a\",(0,e.jsx)(n.span,{className:\"token punctuation\",children:\",\"}),\" \",(0,e.jsx)(n.span,{className:\"token operator\",children:\"*\"}),\"p\",(0,e.jsx)(n.span,{className:\"token punctuation\",children:\")\"}),(0,e.jsx)(n.span,{className:\"token punctuation\",children:\";\"}),`\n`]}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[\"            a\",(0,e.jsx)(n.span,{className:\"token operator\",children:\"->\"}),\"second \",(0,e.jsx)(n.span,{className:\"token operator\",children:\"+=\"}),\" \",(0,e.jsx)(n.span,{className:\"token number\",children:\"1\"}),(0,e.jsx)(n.span,{className:\"token punctuation\",children:\";\"}),`\n`]}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[\"        \",(0,e.jsx)(n.span,{className:\"token punctuation\",children:\"}\"}),`\n`]}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[\"    \",(0,e.jsx)(n.span,{className:\"token punctuation\",children:\"}\"}),`\n`]}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[(0,e.jsx)(n.span,{className:\"token punctuation\",children:\"}\"}),(0,e.jsx)(n.span,{className:\"token punctuation\",children:\";\"}),`\n`]})]})}),`\n`,(0,e.jsx)(n.p,{children:\"\\u6CE8\\u610F\\u70B9:\"}),`\n`,(0,e.jsxs)(n.ol,{children:[`\n`,(0,e.jsxs)(n.li,{children:[`\n`,(0,e.jsxs)(n.p,{children:[(0,e.jsx)(n.a,{href:\"https://oneapi-src.github.io/oneTBB/main/tbb_userguide/concurrent_hash_map.html\",children:(0,e.jsx)(n.code,{children:\"concurrent_hash_map\"})}),\": \\u4E00\\u4E2A\\u652F\\u6301\\u5E76\\u884C\\u7684hash map\"]}),`\n`]}),`\n`,(0,e.jsxs)(n.li,{children:[`\n`,(0,e.jsxs)(n.p,{children:[(0,e.jsx)(n.code,{children:\"oneapi::tbb::blocked_range<...>\"}),\":\"]}),`\n`,(0,e.jsxs)(n.ol,{children:[`\n`,(0,e.jsxs)(n.li,{children:[\"\\u6A21\\u677F\\u53C2\\u6570\\u8BBE\\u7F6E\",(0,e.jsx)(n.strong,{children:\"\\u8FED\\u4EE3\\uFF08\\u4F20\\u5165\\u6570\\u636E\\u7684\\uFF09\\u7C7B\\u578B\"})]}),`\n`,(0,e.jsxs)(n.li,{children:[(0,e.jsx)(n.code,{children:\"tbb::parallel_for\"}),\"\\u4F1A\\u8C03\\u7528\",(0,e.jsx)(n.code,{children:\"Tally(table)\"}),\"\\u7684\",(0,e.jsx)(n.code,{children:\"operator()\"}),\"\\uFF0C\",(0,e.jsx)(n.code,{children:\"blocked_range\"}),\"\\u4F5C\\u4E3A\\u53C2\\u6570\\u4F20\\u5165\",`\n`,(0,e.jsx)(n.pre,{className:\"language-cpp\",children:(0,e.jsxs)(n.code,{className:\"language-cpp code-highlight\",children:[(0,e.jsxs)(n.span,{className:\"code-line\",children:[\"StringTable table\",(0,e.jsx)(n.span,{className:\"token punctuation\",children:\";\"}),`\n`]}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[\"oneapi\",(0,e.jsx)(n.span,{className:\"token double-colon punctuation\",children:\"::\"}),\"tbb\",(0,e.jsx)(n.span,{className:\"token double-colon punctuation\",children:\"::\"}),(0,e.jsx)(n.span,{className:\"token function\",children:\"parallel_for\"}),(0,e.jsx)(n.span,{className:\"token punctuation\",children:\"(\"}),` \n`]}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[\"  oneapi\",(0,e.jsx)(n.span,{className:\"token double-colon punctuation\",children:\"::\"}),\"tbb\",(0,e.jsx)(n.span,{className:\"token double-colon punctuation\",children:\"::\"}),(0,e.jsxs)(n.span,{className:\"token generic-function\",children:[(0,e.jsx)(n.span,{className:\"token function\",children:\"blocked_range\"}),(0,e.jsxs)(n.span,{className:\"token generic class-name\",children:[(0,e.jsx)(n.span,{className:\"token operator\",children:\"<\"}),\"MyString\",(0,e.jsx)(n.span,{className:\"token operator\",children:\"*\"}),(0,e.jsx)(n.span,{className:\"token operator\",children:\">\"})]})]}),(0,e.jsx)(n.span,{className:\"token punctuation\",children:\"(\"}),\"Data\",(0,e.jsx)(n.span,{className:\"token punctuation\",children:\",\"}),\" Data \",(0,e.jsx)(n.span,{className:\"token operator\",children:\"+\"}),\" N\",(0,e.jsx)(n.span,{className:\"token punctuation\",children:\",\"}),\" \",(0,e.jsx)(n.span,{className:\"token number\",children:\"1000\"}),(0,e.jsx)(n.span,{className:\"token punctuation\",children:\")\"}),(0,e.jsx)(n.span,{className:\"token punctuation\",children:\",\"}),` \n`]}),(0,e.jsxs)(n.span,{className:\"code-line\",children:[\"  \",(0,e.jsx)(n.span,{className:\"token function\",children:\"Tally\"}),(0,e.jsx)(n.span,{className:\"token punctuation\",children:\"(\"}),\"table\",(0,e.jsx)(n.span,{className:\"token punctuation\",children:\")\"}),(0,e.jsx)(n.span,{className:\"token punctuation\",children:\")\"}),(0,e.jsx)(n.span,{className:\"token punctuation\",children:\";\"}),`\n`]})]})}),`\n`]}),`\n`]}),`\n`]}),`\n`,(0,e.jsxs)(n.li,{children:[`\n`,(0,e.jsxs)(n.p,{children:[(0,e.jsx)(n.a,{href:\"https://oneapi-src.github.io/oneTBB/main/tbb_userguide/concurrent_hash_map.html\",children:(0,e.jsx)(n.code,{children:\"StringTable::accessor\"})}),\":\"]}),`\n`,(0,e.jsxs)(n.blockquote,{children:[`\n`,(0,e.jsx)(n.p,{children:\"An accessor represents update (write) access. As long as it points to an element, all other attempts to look up that key in the table block until the accessor is done.\"}),`\n`]}),`\n`,(0,e.jsxs)(n.p,{children:[(0,e.jsx)(n.code,{children:\"a->second += 1\"}),\"\\u4EE3\\u8868\\u5BF9value\\u52A01\"]}),`\n`]}),`\n`]}),`\n`,(0,e.jsxs)(n.h2,{id:\"\\u7ED3\\u8BED\",className:\"content-header\",children:[(0,e.jsx)(n.a,{\"aria-hidden\":\"true\",tabIndex:\"-1\",href:\"#\\u7ED3\\u8BED\",children:(0,e.jsx)(n.span,{className:\"icon icon-link\"})}),\"\\u7ED3\\u8BED\"]}),`\n`,(0,e.jsx)(n.p,{children:\"\\u8FD9\\u4EFD\\u4EE3\\u7801\\u6837\\u4F8B\\u5C55\\u793A\\u4E86\\u57FA\\u4E8Etbb\\u7684\\u5E76\\u884Chash\\u7684\\u5B9E\\u73B0\\uFF0C\\u5305\\u542B\\u4E86tbb\\u7684\\u4E00\\u4E9B\\u57FA\\u7840\\u7528\\u6CD5\\uFF0C\\u5177\\u6709\\u4E00\\u5B9A\\u53C2\\u8003\\u4EF7\\u503C\\u3002\"})]})}function p(a={}){let{wrapper:n}=a.components||{};return n?(0,e.jsx)(n,{...a,children:(0,e.jsx)(d,{...a})}):d(a)}return _(w);})();\n;return Component;"
  },
  "_id": "blog/Systems/tbb-sample-count-string.md",
  "_raw": {
    "sourceFilePath": "blog/Systems/tbb-sample-count-string.md",
    "sourceFileName": "tbb-sample-count-string.md",
    "sourceFileDir": "blog/Systems",
    "contentType": "markdown",
    "flattenedPath": "blog/Systems/tbb-sample-count-string"
  },
  "type": "Blog",
  "readingTime": {
    "text": "3 min read",
    "minutes": 2.41,
    "time": 144600,
    "words": 482
  },
  "slug": "tbb-sample-count-string",
  "path": "blog/Systems/tbb-sample-count-string",
  "toc": [
    {
      "value": "简介",
      "url": "#简介",
      "depth": 2
    },
    {
      "value": "细节",
      "url": "#细节",
      "depth": 2
    },
    {
      "value": "重载hash",
      "url": "#重载hash",
      "depth": 3
    },
    {
      "value": "定义MyString类，",
      "url": "#定义mystring类",
      "depth": 3
    },
    {
      "value": "并行Hash Map",
      "url": "#并行hash-map",
      "depth": 3
    },
    {
      "value": "结语",
      "url": "#结语",
      "depth": 2
    }
  ],
  "structuredData": {
    "@context": "https://schema.org",
    "@type": "BlogPosting",
    "headline": "TBB Sample 01",
    "datePublished": "2022-11-29T00:00:00.000Z",
    "dateModified": "2022-11-29T00:00:00.000Z",
    "description": "Count Strings",
    "url": "https://zhangjian94cn.github.io/blog/tbb-sample-count-string"
  }
}